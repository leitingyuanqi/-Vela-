<template>
	<div class="page" style="flex-direction: column;">

	  <img if="{{fileList.length == 0}}" src="/common/images/empty.png"
		  style="position: absolute;left: 46px;top: 165px;width: 120px;height: 120px;" />

	  <text if="{{fileList.length == 0}}" style="position: absolute;left: 0px;top: 307.5px;width: 212px;line-height: 42px;font-weight:bold;font-size:35px;color:white;text-align:center;">书架空空</text>

	  <list class="list">
		  <list-item for="{{fileList}}" class="item" @click="selectFile($item)" type="nook">
			  <text class="itemtext">{{$item.name}}</text>
			  <text class="itemtext2">已阅读 {{$item.percent}}%</text>
		  </list-item>
	  </list>
	  <img static src="/common/images/mask_up.png" style="position: absolute;top: 0;left: 0;"/>
	  <img src="/common/images/more.png" @click="routerTo('more')" style="position: absolute;left: 49.5px;top: 6.6px;width: 113px;height: 80px;"/>
	  <img if="{{fileList.length == 0}}" src="/common/images/push.png"
		  style="position: absolute;left: 49.5px;top: 433.8px;width: 113px;height: 80px;" @click="routerTo('push')"/>

	  <!-- <text style="position: absolute;left: 0px;top: 240px;width: 212px;font-weight:bold;font-size:20px;color:red;">{{debugOutput}}</text> -->
	</div>
</template>

<script>
import router from '@system.router';
import file from '@system.file';
import storage from '../../common/storage.js';
/* import interconnect from '@system.interconnect' */

const INIT_PATH = "internal://files/books";
const SAVED_KEY = "EBOOK_SAVED";
let savedPersent = {};

// const teststr = `,测试文本0,测试文本1,测试文本2,测试文本3,测试文本4,测试文本5,测试文本6,测试文本7,测试文本8,测试文本9,测试文本10,测试文本11,测试文本12,测试文本13,测试文本14,测试文本15,测试文本16,测试文本17,测试文本18,测试文本19,测试文本20,测试文本21,测试文本22,测试文本23,测试文本24,测试文本25,测试文本26,测试文本27,测试文本28,测试文本29,测试文本30,测试文本31,测试文本32,测试文本33,测试文本34,测试文本35,测试文本36,测试文本37,测试文本38,测试文本39,测试文本40,测试文本41,测试文本42,测试文本43,测试文本44,测试文本45,测试文本46,测试文本47,测试文本48,测试文本49,测试文本50,测试文本51,测试文本52,测试文本53,测试文本54,测试文本55,测试文本56,测试文本57,测试文本58,测试文本59,测试文本60,测试文本61,测试文本62,测试文本63,测试文本64,测试文本65,测试文本66,测试文本67,测试文本68,测试文本69,测试文本70,测试文本71,测试文本72,测试文本73,测试文本74,测试文本75,测试文本76,测试文本77,测试文本78,测试文本79,测试文本80,测试文本81,测试文本82,测试文本83,测试文本84,测试文本85,测试文本86,测试文本87,测试文本88,测试文本89,测试文本90,测试文本91,测试文本92,测试文本93,测试文本94,测试文本95,测试文本96,测试文本97,测试文本98,测试文本99,测试文本100,测试文本101,测试文本102,测试文本103,测试文本104,测试文本105,测试文本106,测试文本107,测试文本108,测试文本109,测试文本110,测试文本111,测试文本112,测试文本113,测试文本114,测试文本115,测试文本116,测试文本117,测试文本118,测试文本119,测试文本120,测试文本121,测试文本122,测试文本123,测试文本124,测试文本125,测试文本126,测试文本127,测试文本128,测试文本129,测试文本130,测试文本131,测试文本132,测试文本133,测试文本134,测试文本135,测试文本136,测试文本137,测试文本138,测试文本139,测试文本140,测试文本141,测试文本142,测试文本143,测试文本144,测试文本145,测试文本146,测试文本147,测试文本148,测试文本149,测试文本150,测试文本151,测试文本152,测试文本153,测试文本154,测试文本155,测试文本156,测试文本157,测试文本158,测试文本159,测试文本160,测试文本161,测试文本162,测试文本163,测试文本164,测试文本165,测试文本166,测试文本167,测试文本168,测试文本169,测试文本170,测试文本171,测试文本172,测试文本173,测试文本174,测试文本175,测试文本176,测试文本177,测试文本178,测试文本179,测试文本180,测试文本181,测试文本182,测试文本183,测试文本184,测试文本185,测试文本186,测试文本187,测试文本188,测试文本189,测试文本190,测试文本191,测试文本192,测试文本193,测试文本194,测试文本195,测试文本196,测试文本197,测试文本198,测试文本199,测试文本200,测试文本201,测试文本202,测试文本203,测试文本204,测试文本205,测试文本206,测试文本207,测试文本208,测试文本209,测试文本210,测试文本211,测试文本212,测试文本213,测试文本214,测试文本215,测试文本216,测试文本217,测试文本218,测试文本219,测试文本220,测试文本221,测试文本222,测试文本223,测试文本224,测试文本225,测试文本226,测试文本227,测试文本228,测试文本229,测试文本230,测试文本231,测试文本232,测试文本233,测试文本234,测试文本235,测试文本236,测试文本237,测试文本238,测试文本239,测试文本240,测试文本241,测试文本242,测试文本243,测试文本244,测试文本245,测试文本246,测试文本247,测试文本248,测试文本249,测试文本250,测试文本251,测试文本252,测试文本253,测试文本254,测试文本255,测试文本256,测试文本257,测试文本258,测试文本259,测试文本260,测试文本261,测试文本262,测试文本263,测试文本264,测试文本265,测试文本266,测试文本267,测试文本268,测试文本269,测试文本270,测试文本271,测试文本272,测试文本273,测试文本274,测试文本275,测试文本276,测试文本277,测试文本278,测试文本279,测试文本280,测试文本281,测试文本282,测试文本283,测试文本284,测试文本285,测试文本286,测试文本287,测试文本288,测试文本289,测试文本290,测试文本291,测试文本292,测试文本293,测试文本294,测试文本295,测试文本296,测试文本297,测试文本298,测试文本299,测试文本300,测试文本301,测试文本302,测试文本303,测试文本304,测试文本305,测试文本306,测试文本307,测试文本308,测试文本309,测试文本310,测试文本311,测试文本312,测试文本313,测试文本314,测试文本315,测试文本316,测试文本317,测试文本318,测试文本319,测试文本320,测试文本321,测试文本322,测试文本323,测试文本324,测试文本325,测试文本326,测试文本327,测试文本328,测试文本329,测试文本330,测试文本331,测试文本332,测试文本333,测试文本334,测试文本335,测试文本336,测试文本337,测试文本338,测试文本339,测试文本340,测试文本341,测试文本342,测试文本343,测试文本344,测试文本345,测试文本346,测试文本347,测试文本348,测试文本349,测试文本350,测试文本351,测试文本352,测试文本353,测试文本354,测试文本355,测试文本356,测试文本357,测试文本358,测试文本359,测试文本360,测试文本361,测试文本362,测试文本363,测试文本364,测试文本365,测试文本366,测试文本367,测试文本368,测试文本369,测试文本370,测试文本371,测试文本372,测试文本373,测试文本374,测试文本375,测试文本376,测试文本377,测试文本378,测试文本379,测试文本380,测试文本381,测试文本382,测试文本383,测试文本384,测试文本385,测试文本386,测试文本387,测试文本388,测试文本389,测试文本390,测试文本391,测试文本392,测试文本393,测试文本394,测试文本395,测试文本396,测试文本397,测试文本398,测试文本399,测试文本400,测试文本401,测试文本402,测试文本403,测试文本404,测试文本405,测试文本406,测试文本407,测试文本408,测试文本409,测试文本410,测试文本411,测试文本412,测试文本413,测试文本414,测试文本415,测试文本416,测试文本417,测试文本418,测试文本419,测试文本420,测试文本421,测试文本422,测试文本423,测试文本424,测试文本425,测试文本426,测试文本427,测试文本428,测试文本429,测试文本430,测试文本431,测试文本432,测试文本433,测试文本434,测试文本435,测试文本436,测试文本437,测试文本438,测试文本439,测试文本440,测试文本441,测试文本442,测试文本443,测试文本444,测试文本445,测试文本446,测试文本447,测试文本448,测试文本449,测试文本450,测试文本451,测试文本452,测试文本453,测试文本454,测试文本455,测试文本456,测试文本457,测试文本458,测试文本459,测试文本460,测试文本461,测试文本462,测试文本463,测试文本464,测试文本465,测试文本466,测试文本467,测试文本468,测试文本469,测试文本470,测试文本471,测试文本472,测试文本473,测试文本474,测试文本475,测试文本476,测试文本477,测试文本478,测试文本479,测试文本480,测试文本481,测试文本482,测试文本483,测试文本484,测试文本485,测试文本486,测试文本487,测试文本488,测试文本489,测试文本490,测试文本491,测试文本492,测试文本493,测试文本494,测试文本495,测试文本496,测试文本497,测试文本498,测试文本499,测试文本500,测试文本501,测试文本502,测试文本503,测试文本504,测试文本505,测试文本506,测试文本507,测试文本508,测试文本509,测试文本510,测试文本511,测试文本512,测试文本513,测试文本514,测试文本515,测试文本516,测试文本517,测试文本518,测试文本519,测试文本520,测试文本521,测试文本522,测试文本523,测试文本524,测试文本525,测试文本526,测试文本527,测试文本528,测试文本529,测试文本530,测试文本531,测试文本532,测试文本533,测试文本534,测试文本535,测试文本536,测试文本537,测试文本538,测试文本539,测试文本540,测试文本541,测试文本542,测试文本543,测试文本544,测试文本545,测试文本546,测试文本547,测试文本548,测试文本549,测试文本550,测试文本551,测试文本552,测试文本553,测试文本554,测试文本555,测试文本556,测试文本557,测试文本558,测试文本559,测试文本560,测试文本561,测试文本562,测试文本563,测试文本564,测试文本565,测试文本566,测试文本567,测试文本568,测试文本569,测试文本570,测试文本571,测试文本572,测试文本573,测试文本574,测试文本575,测试文本576,测试文本577,测试文本578,测试文本579,测试文本580,测试文本581,测试文本582,测试文本583,测试文本584,测试文本585,测试文本586,测试文本587,测试文本588,测试文本589,测试文本590,测试文本591,测试文本592,测试文本593,测试文本594,测试文本595,测试文本596,测试文本597,测试文本598,测试文本599,测试文本600,测试文本601,测试文本602,测试文本603,测试文本604,测试文本605,测试文本606,测试文本607,测试文本608,测试文本609,测试文本610,测试文本611,测试文本612,测试文本613,测试文本614,测试文本615,测试文本616,测试文本617,测试文本618,测试文本619,测试文本620,测试文本621,测试文本622,测试文本623,测试文本624,测试文本625,测试文本626,测试文本627,测试文本628,测试文本629,测试文本630,测试文本631,测试文本632,测试文本633,测试文本634,测试文本635,测试文本636,测试文本637,测试文本638,测试文本639,测试文本640,测试文本641,测试文本642,测试文本643,测试文本644,测试文本645,测试文本646,测试文本647,测试文本648,测试文本649,测试文本650,测试文本651,测试文本652,测试文本653,测试文本654,测试文本655,测试文本656,测试文本657,测试文本658,测试文本659,测试文本660,测试文本661,测试文本662,测试文本663,测试文本664,测试文本665,测试文本666,测试文本667,测试文本668,测试文本669,测试文本670,测试文本671,测试文本672,测试文本673,测试文本674,测试文本675,测试文本676,测试文本677,测试文本678,测试文本679,测试文本680,测试文本681,测试文本682,测试文本683,测试文本684,测试文本685,测试文本686,测试文本687,测试文本688,测试文本689,测试文本690,测试文本691,测试文本692,测试文本693,测试文本694,测试文本695,测试文本696,测试文本697,测试文本698,测试文本699,测试文本700,测试文本701,测试文本702,测试文本703,测试文本704,测试文本705,测试文本706,测试文本707,测试文本708,测试文本709,测试文本710,测试文本711,测试文本712,测试文本713,测试文本714,测试文本715,测试文本716,测试文本717,测试文本718,测试文本719,测试文本720,测试文本721,测试文本722,测试文本723,测试文本724,测试文本725,测试文本726,测试文本727,测试文本728,测试文本729,测试文本730,测试文本731,测试文本732,测试文本733,测试文本734,测试文本735,测试文本736,测试文本737,测试文本738,测试文本739,测试文本740,测试文本741,测试文本742,测试文本743,测试文本744,测试文本745,测试文本746,测试文本747,测试文本748,测试文本749,测试文本750,测试文本751,测试文本752,测试文本753,测试文本754,测试文本755,测试文本756,测试文本757,测试文本758,测试文本759,测试文本760,测试文本761,测试文本762,测试文本763,测试文本764,测试文本765,测试文本766,测试文本767,测试文本768,测试文本769,测试文本770,测试文本771,测试文本772,测试文本773,测试文本774,测试文本775,测试文本776,测试文本777,测试文本778,测试文本779,测试文本780,测试文本781,测试文本782,测试文本783,测试文本784,测试文本785,测试文本786,测试文本787,测试文本788,测试文本789,测试文本790,测试文本791,测试文本792,测试文本793,测试文本794,测试文本795,测试文本796,测试文本797,测试文本798,测试文本799,测试文本800,测试文本801,测试文本802,测试文本803,测试文本804,测试文本805,测试文本806,测试文本807,测试文本808,测试文本809,测试文本810,测试文本811,测试文本812,测试文本813,测试文本814,测试文本815,测试文本816,测试文本817,测试文本818,测试文本819,测试文本820,测试文本821,测试文本822,测试文本823,测试文本824,测试文本825,测试文本826,测试文本827,测试文本828,测试文本829,测试文本830,测试文本831,测试文本832,测试文本833,测试文本834,测试文本835,测试文本836,测试文本837,测试文本838,测试文本839,测试文本840,测试文本841,测试文本842,测试文本843,测试文本844,测试文本845,测试文本846,测试文本847,测试文本848,测试文本849,测试文本850,测试文本851,测试文本852,测试文本853,测试文本854,测试文本855,测试文本856,测试文本857,测试文本858,测试文本859,测试文本860,测试文本861,测试文本862,测试文本863,测试文本864,测试文本865,测试文本866,测试文本867,测试文本868,测试文本869,测试文本870,测试文本871,测试文本872,测试文本873,测试文本874,测试文本875,测试文本876,测试文本877,测试文本878,测试文本879,测试文本880,测试文本881,测试文本882,测试文本883,测试文本884,测试文本885,测试文本886,测试文本887,测试文本888,测试文本889,测试文本890,测试文本891,测试文本892,测试文本893,测试文本894,测试文本895,测试文本896,测试文本897,测试文本898,测试文本899,测试文本900,测试文本901,测试文本902,测试文本903,测试文本904,测试文本905,测试文本906,测试文本907,测试文本908,测试文本909,测试文本910,测试文本911,测试文本912,测试文本913,测试文本914,测试文本915,测试文本916,测试文本917,测试文本918,测试文本919,测试文本920,测试文本921,测试文本922,测试文本923,测试文本924,测试文本925,测试文本926,测试文本927,测试文本928,测试文本929,测试文本930,测试文本931,测试文本932,测试文本933,测试文本934,测试文本935,测试文本936,测试文本937,测试文本938,测试文本939,测试文本940,测试文本941,测试文本942,测试文本943,测试文本944,测试文本945,测试文本946,测试文本947,测试文本948,测试文本949,测试文本950,测试文本951,测试文本952,测试文本953,测试文本954,测试文本955,测试文本956,测试文本957,测试文本958,测试文本959,测试文本960,测试文本961,测试文本962,测试文本963,测试文本964,测试文本965,测试文本966,测试文本967,测试文本968,测试文本969,测试文本970,测试文本971,测试文本972,测试文本973,测试文本974,测试文本975,测试文本976,测试文本977,测试文本978,测试文本979,测试文本980,测试文本981,测试文本982,测试文本983,测试文本984,测试文本985,测试文本986,测试文本987,测试文本988,测试文本989,测试文本990,测试文本991,测试文本992,测试文本993,测试文本994,测试文本995,测试文本996,测试文本997,测试文本998,测试文本999,测试文本1000,测试文本1001,测试文本1002,测试文本1003,测试文本1004,测试文本1005,测试文本1006,测试文本1007,测试文本1008,测试文本1009,测试文本1010,`;


function str2ab(str) {
  var buf = new ArrayBuffer(str.length*2);
  var bufView = new Uint16Array(buf);
  for (var i=0, strLen=str.length; i<strLen; i++){
    bufView[i] = str.charCodeAt(i);
  }
  return new Uint8Array(bufView.buffer);
}

export default {
  private: {
    fileList: [],
    debugOutput: "初始化中..."
  },
  onShow() {
    this.loadFileList();
  },
  loadFileList() {
    const that = this;
    // 1. 先从storage拿进度信息
    storage.get({
      key: SAVED_KEY,
      success: function (data) {
        if (data) {
          savedPersent = JSON.parse(data);
          that.debugOutput = "读取存储信息成功：" + data;
        } else {
          savedPersent = {};
          that.debugOutput = "当前无存储信息";
        }
        // 2. 成功或无信息都要继续读取文件列表
        that._doListFiles();
      },
      fail: function (errData, code) {
        // 如果获取storage失败，也初始化一个空对象
        savedPersent = {};
        that.debugOutput = `storage.get失败，错误码: ${code}`;
        // 同样继续读取文件列表
        that._doListFiles();
      }
    });
  },
  // 将读取文件列表封装成一个私有方法，方便在 storage 获取成功/失败后调用
  _doListFiles() {
    const that = this;
    file.list({
      uri: INIT_PATH + '/',
      success: function (data) {
        if (data && data.fileList) {
          // 3. 生成本地文件列表并与存储信息合并
          const fileArray = data.fileList
            .filter(item => item.type === 'file') // 筛选出文件类型
            .map(item => {
              // 去掉 .txt 后缀
              const rawName = item.uri.split('/').pop().replace('.txt', '');
              // 如果该文件名在 savedPersent 中，则取 p 的值，否则初始化
              if (!savedPersent[rawName]) {
                savedPersent[rawName] = { p: 0, s: 0, o: 0 };
              }
              return {
                name: rawName,
                // 将进度赋值给 item 用于界面展示
                percent: savedPersent[rawName].p || 0
              };
            });
          that.fileList = fileArray;
        //   that.debugOutput = "文件列表加载成功: " + JSON.stringify(fileArray);

          // 4. 如果有新添加的文件，或本地进度信息有更新，需写回 storage
          storage.set({
            key: SAVED_KEY,
            value: JSON.stringify(savedPersent),
            success: () => {
              console.log("更新进度信息成功");
            },
            fail: (err, code) => {
              console.log("更新进度信息失败, code=", code);
            }
          });
        } else {
          that.debugOutput = "没有文件可显示";
          that.fileList = [];
        }
      },
      fail: function (errData, code) {
        that.debugOutput = `文件加载失败: 错误代码 ${code}`;
        that.fileList = [];
      }
    });
  },

  selectFile(item) {
    router.push({
      uri: '/pages/detail',
      params: {
        cPath: INIT_PATH + '/' + item.name + '.txt',
        name: item.name
      }
    });
  },

  routerTo(page) {
    router.push({
      uri: `/pages/${page}`
    });
  }
};

</script>

<style>
.page {
	width: 212px;
	height: 520px;
	background-color: #000000;
}

/* 更多信息样式 */

.list {
	width: 212px;
	height: 520px;
	position: absolute;
	top:0px;
	left:0px;
	padding-top: 93px;
	padding-bottom: 73px;
	/* background-color: red; */
}

.item {
	width: 212px;
	height: 122px;
	padding: 16px 14px;
	margin-bottom: 8.8px;
	background-color: #262626;
	border-radius: 30px;
	flex-direction: column;
  justify-content: space-between;
}

.itemtext {
	font-size: 35px;
	line-height:40px;
	width: 100%;
	font-weight: bold;
	color: white;
	text-overflow: ellipsis;
	lines: 1;
	/* padding-left:12px; */
	/* padding-right:12px; */
	/* padding-top:12px; */
}

.itemtext2 {
	font-size: 30px;
	line-height: 36px;
	width: 100%;
	font-weight: bold;
	color: #a8a8a8;
	text-overflow: ellipsis;
	lines: 1;
	/* padding-right:12px; */
}

</style>